import t from"unstorage/drivers/memory";import{prefixStorage as e,createStorage as i}from"C:/Users/sao/Documents/my-site/node_modules/unstorage/dist/index.mjs";import{joinURL as r,withBase as n}from"C:/Users/sao/Documents/my-site/node_modules/ufo/dist/index.mjs";import{g as s,b as o,c as a,d as u,o as c,f as l,h as d,i as m,k as f}from"./query-Dj9UOrgE.js";import{pascalCase as p}from"scule";import"slugify";import{b as g,e as h}from"../server.mjs";import{u as y}from"./preview-C8Om5VAN.js";import"C:/Users/sao/Documents/my-site/node_modules/ohash/dist/index.mjs";import"vue";import"C:/Users/sao/Documents/my-site/node_modules/klona/dist/index.mjs";import"ofetch";import"#internal/nuxt/paths";import"C:/Users/sao/Documents/my-site/node_modules/hookable/dist/index.mjs";import"C:/Users/sao/Documents/my-site/node_modules/unctx/dist/index.mjs";import"C:/Users/sao/Documents/my-site/node_modules/h3/dist/index.mjs";import"vue-router";import"C:/Users/sao/Documents/my-site/node_modules/radix3/dist/index.mjs";import"C:/Users/sao/Documents/my-site/node_modules/defu/dist/defu.mjs";import"vue/server-renderer";import"C:/Users/sao/Documents/my-site/node_modules/@unhead/vue/dist/index.mjs";import"C:/Users/sao/Documents/my-site/node_modules/nuxt/node_modules/cookie-es/dist/index.mjs";import"C:/Users/sao/Documents/my-site/node_modules/destr/dist/index.mjs";import"C:/Users/sao/Documents/my-site/node_modules/nuxt/node_modules/ohash/dist/index.mjs";function _(t={}){const e=function(t,e={}){return{$match:(e,i)=>t(e,i),$eq:(t,e)=>e instanceof RegExp?e.test(t):t===e,$ne:(t,e)=>e instanceof RegExp?!e.test(t):t!==e,$not:(e,i)=>!t(e,i),$and:(e,i)=>(a(i,"$and requires an array as condition"),i.every(i=>t(e,i))),$or:(e,i)=>(a(i,"$or requires an array as condition"),i.some(i=>t(e,i))),$in:(e,i)=>o(i).some(i=>Array.isArray(e)?t(e,{$contains:i}):t(e,i)),$contains:(t,e)=>(t=Array.isArray(t)?t:String(t),o(e).every(e=>t.includes(e))),$icontains:(t,e)=>{if("string"!=typeof e)throw new TypeError("$icontains requires a string, use $contains instead");return t=String(t).toLocaleLowerCase(),o(e).every(e=>t.includes(e.toLocaleLowerCase()))},$containsAny:(t,e)=>(a(e,"$containsAny requires an array as condition"),t=Array.isArray(t)?t:String(t),e.some(e=>t.includes(e))),$exists:(t,e)=>e?void 0!==t:void 0===t,$type:(t,e)=>typeof t===String(e),$regex:(t,e)=>{if(!(e instanceof RegExp)){const t=String(e).match(/\/(.*)\/([dgimsuy]*)$/);e=t?.[1]?new RegExp(t[1],t[2]||""):new RegExp(e)}return e.test(String(t||""))},$lt:(t,e)=>t<e,$lte:(t,e)=>t<=e,$gt:(t,e)=>t>e,$gte:(t,e)=>t>=e,...e||{}}}(i,t.operators);function i(t,r){return"object"!=typeof r||r instanceof RegExp?e.$eq(t,r):Object.keys(r||{}).every(n=>{const o=r[n];if(n.startsWith("$")&&e[n]){const i=e[n];return"function"==typeof i&&i(t,o)}return i(s(t,n),o)})}return i}function $(t){const e=_(),i=[(t,i)=>{const r=t.result.filter(t=>o(i.where).every(i=>e(t,i)));return{...t,result:r,total:r.length}},(t,e)=>o(e.sort).forEach(e=>l(t.result,e)),function(t,i,r){if(i.surround){let n=((t,{query:i,before:r,after:n})=>{const s="string"==typeof i?{_path:i}:i,o=t.findIndex(t=>e(t,s));r=r??1,n=n??1;const a=new Array(r+n).fill(null,0);return-1===o?a:a.map((e,i)=>t[o-r+i+Number(i>=r)]||null)})(1===t.result?.length?r:t.result,i.surround);n=u(d(i.without))(n),n=u(m(i.only))(n),t.surround=n}return t}],n=[(t,e)=>{if(e.skip)return{...t,result:t.result.slice(e.skip),skip:e.skip}},(t,e)=>{if(e.limit)return{...t,result:t.result.slice(0,e.limit),limit:e.limit}},function(t,e,i){if(e.dirConfig){const n=t.result[0]?._path||e.where?.find(t=>t._path)?._path;if("string"==typeof n){const e=i.find(t=>t._path===r(n,"_dir"));e&&(t.dirConfig={_path:e._path,...d(["_"])(e)})}}return t},(t,e)=>({...t,result:u(d(e.without))(t.result)}),(t,e)=>({...t,result:u(m(e.only))(t.result)})];return async e=>{const r=await t(),s=e.params(),o={result:r,limit:0,skip:0,total:r.length},a=i.reduce((t,e)=>e(t,s,r)||t,o);if(s.count)return{result:a.result.length};const u=n.reduce((t,e)=>e(t,s,r)||t,a);return s.first?{...c(["skip","limit","total"])(u),result:u.result[0]}:u}}function v(t){const e=$(t);return async t=>{t.params().first&&t.withDirConfig();const i=t.params(),r=await e(t);return i.surround?r?.surround:(r?.dirConfig&&(r.result={_path:r.dirConfig?._path,...r.result,_dir:r.dirConfig}),r?.result)}}function w(t,e){const{navigation:i}=g().public.content;if(!1===i)return[];const r=t=>{return{...(r=["title",...i.fields],t=>(t=t||{},r&&r.length?r.filter(e=>void 0!==t[e]).reduce((e,i)=>Object.assign(e,{[i]:t[i]}),{}):t))(t),...(e=t?.navigation,"[object Object]"===Object.prototype.toString.call(e)?t.navigation:{})};var e,r};return x(t.sort((t,e)=>t._path.localeCompare(e._path)).reduce((t,i)=>{const n=i._path.substring(1).split("/"),s=i._id.split(":").slice(1),o=!!s[s.length-1]?.match(/([1-9][0-9]*\.)?index.md/g),a=t=>({title:t.title,_path:t._path,_file:t._file,children:[],...r(t),...t._draft?{_draft:!0}:{}}),u=a(i);if(o){const n=e[u._path];if(void 0!==n?.navigation&&!n?.navigation)return t;if("/"!==i._path){const t=a(i);u.children.push(t)}n&&Object.assign(u,r(n))}if(1===n.length)return t.push(u),t;return n.slice(0,-1).reduce((t,s,o)=>{const a="/"+n.slice(0,o+1).join("/"),u=e[a];if(void 0!==u?.navigation&&!u.navigation)return[];let c=t.find(t=>t._path===a);var l;return c||(c={title:(l=s,l.split(/[\s-]/g).map(p).join(" ")),_path:a,_file:i._file,children:[],...u&&r(u)},t.push(c)),c.children},t).push(u),t},[]))}const j=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function x(t){t.forEach(t=>{t._file=t._file.split(".").slice(0,-1).join(".")});const e=t.sort((t,e)=>j.compare(t._file,e._file));for(const i of e)i.children?.length?x(i.children):delete i.children,delete i._file;return t}const C=e(i({driver:t()}),"@content");function b(t){async function e(){const e=new Set(await t.getKeys("cache:")),i=y().getPreviewToken();if(i){const r=await t.getItem(`${i}$`).then(t=>t||{});if(Array.isArray(r.ignoreSources)){const t=r.ignoreSources.map(t=>`cache:${t.trim()}:`);for(const i of e)t.some(t=>i.startsWith(t))&&e.delete(i)}const n=await t.getKeys(`${i}:`),s=await Promise.all(n.map(e=>t.getItem(e)));for(const t of s)e.delete(`cache:${t._id}`),t.__deleted||e.add(`${i}:${t._id}`)}return await Promise.all(Array.from(e).map(e=>t.getItem(e)))}return{storage:t,fetch:v(e),query:t=>f(v(e),{initialParams:t,legacy:!0})}}let k=null,D=null;async function U(){return D?await D:k||(D=async function(){const t=h(),{content:e}=g().public,i=b(C),r=await i.storage.getItem("integrity");if(e.integrity!==+(r||0)){const{contents:t,navigation:r}=await $fetch((s=e.integrity?`cache.${e.integrity}.json`:"cache.json",n(s,g().public.content.api.baseURL)));await Promise.all(t.map(t=>i.storage.setItem(`cache:${t._id}`,t))),await i.storage.setItem("navigation",r),await i.storage.setItem("integrity",e.integrity)}var s;return await t.callHook("content:storage",i.storage),i}(),k=await D),k}async function A(t){const e=await U();if(!y().getPreviewToken()&&0===Object.keys(t||{}).length)return e.storage.getItem("navigation");return w(await e.query(t).where({_partial:!1,navigation:{$ne:!1}}).find(),(await e.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce((t,e)=>{"dir"===e.title?.toLowerCase()&&(e.title=void 0);return t[e._path.split("/").slice(0,-1).join("/")||"/"]={...e,...e.body},t},{}))}export{C as contentStorage,b as createDB,A as generateNavigation,U as useContentDatabase};
//# sourceMappingURL=client-db-CqP39rKe.js.map
